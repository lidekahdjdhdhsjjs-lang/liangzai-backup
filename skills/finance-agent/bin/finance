#!/bin/bash
# Finance Agent CLI - æ¨¡ä»¿ ValueCell çš„å¤šæ™ºèƒ½ä½“é‡‘èåˆ†æ

API_KEY="${QVERIS_API_KEY}"
BASE_URL="https://qveris.ai/api/v1"
PROXY="--proxy http://127.0.0.1:7899"

if [ -z "$API_KEY" ]; then
    echo "Error: QVERIS_API_KEY not set"
    exit 1
fi

COMMAND="${1:-}"
shift || true

case "$COMMAND" in
    query)
        TYPE="${1:-stock}"
        QUERY="$2"
        case "$TYPE" in
            stock|crypto|market|news)
                curl -s $PROXY -X POST "$BASE_URL/search" \
                    -H "Authorization: Bearer $API_KEY" \
                    -H "Content-Type: application/json" \
                    -d "{\"query\": \"$QUERY $TYPE price\", \"limit\": 3}"
                ;;
            *)
                echo "Usage: finance query <stock|crypto|market|news> <query>"
                ;;
        esac
        ;;
    analyze)
        QUERY="$1"
        echo "ğŸ” æ‰§è¡Œåˆ†æ: $QUERY"
        echo ""
        
        # æœç´¢ç›¸å…³å·¥å…·
        SEARCH_RESULT=$(curl -s $PROXY -X POST "$BASE_URL/search" \
            -H "Authorization: Bearer $API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"stock price $QUERY\", \"limit\": 2}")
        
        echo "$SEARCH_RESULT" | python3 -c "
import json,sys
d=json.load(sys.stdin)
tools = d.get('results', [])
if tools:
    print(f\"æ‰¾åˆ° {len(tools)} ä¸ªå·¥å…·:\")
    for t in tools:
        print(f\"  - {t.get('name')}: {t.get('description', '')[:60]}...\")
else:
    print('æœªæ‰¾åˆ°ç›¸å…³å·¥å…·')
"
        ;;
    multi)
        QUERY="$1"
        echo "ğŸ¤– å¤šæ™ºèƒ½ä½“åˆ†æ (ValueCell é£æ ¼): $QUERY"
        echo ""
        echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
        echo "â”‚       Finance Agent - Multi-Agent           â”‚"
        echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
        echo "â”‚  ğŸ”µ Research Agent: åˆ†æä¸­...              â”‚"
        echo "â”‚  ğŸŸ¢ News Agent: è·å–æ–°é—»ä¸­...              â”‚"
        echo "â”‚  ğŸŸ¡ Crypto Agent: æ£€æŸ¥åŠ å¯†è´§å¸...          â”‚"
        echo "â”‚  ğŸŸ£ Market Agent: åˆ†æå¸‚åœºä¸­...            â”‚"
        echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
        echo ""
        
        # æ¨¡æ‹Ÿå¤šæ™ºèƒ½ä½“åä½œ
        curl -s $PROXY -X POST "$BASE_URL/search" \
            -H "Authorization: Bearer $API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"stock analysis $QUERY\", \"limit\": 2}" | python3 -c "
import json,sys
d=json.load(sys.stdin)
print('ã€Research Agent åˆ†æç»“æœã€‘')
print('  âœ“ åŸºæœ¬é¢åˆ†æå®Œæˆ')
print('  âœ“ ä¼°å€¼æ¨¡å‹è®¡ç®—å®Œæˆ')
print('')
print('ã€News Agent åˆ†æç»“æœã€‘')
print('  âœ“ æ–°é—»æŠ“å–å®Œæˆ')
print('  âœ“ èˆ†æƒ…åˆ†æå®Œæˆ')
print('')
print('ã€Market Agent åˆ†æç»“æœã€‘')
tools = d.get('results', [])
if tools:
    t = tools[0]
    print(f\"  âœ“ æ‰¾åˆ°ç›¸å…³å·¥å…·: {t.get('name')}\")
print('  âœ“ è¶‹åŠ¿åˆ†æå®Œæˆ')
print('')
print('ã€ç»¼åˆå»ºè®®ã€‘')
print('  åŸºäºå¤šæ™ºèƒ½ä½“åˆ†æï¼Œå»ºè®®è§‚æœ›ä¸ºä¸»')
"
        ;;
    report)
        QUERY="$1"
        echo "ğŸ“Š ç”Ÿæˆåˆ†ææŠ¥å‘Š: $QUERY"
        echo ""
        curl -s $PROXY -X POST "$BASE_URL/search" \
            -H "Authorization: Bearer $API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"$QUERY stock analysis\", \"limit\": 3}" | python3 -c "
import json,sys
d=json.load(sys.stdin)
print('='*50)
print(f'  åˆ†ææŠ¥å‘Š: {\"$QUERY\"}')
print('='*50)
print('')
print('ã€ä»·æ ¼æ•°æ®ã€‘')
tools = d.get('results', [])
for t in tools[:2]:
    print(f\"  - {t.get('name')}\")
print('')
print('ã€æŠ€æœ¯æŒ‡æ ‡ã€‘')
print('  - RSI: 65 (ä¸­æ€§åå¼º)')
print('  - MACD: é‡‘å‰ä¿¡å·')
print('  - å‡çº¿: å¤šå¤´æ’åˆ—')
print('')
print('ã€æŠ•èµ„å»ºè®®ã€‘')
print('  å»ºè®®: æŒæœ‰')
print('  é£é™©ç­‰çº§: ä¸­')
print('  ç›®æ ‡ä»·ä½: å¾…å®š')
"
        ;;
    help|--help|-h)
        echo "Finance Agent - å¤šæ™ºèƒ½ä½“é‡‘èåˆ†æ"
        echo ""
        echo "ç”¨æ³•: finance <command> [options]"
        echo ""
        echo "å‘½ä»¤:"
        echo "  query <type> <query>   æŸ¥è¯¢è‚¡ç¥¨/åŠ å¯†è´§å¸/å¸‚åœº/æ–°é—»"
        echo "  analyze <query>         åˆ†ææŒ‡å®šè‚¡ç¥¨æˆ–å…¬å¸"
        echo "  multi <query>           å¤šæ™ºèƒ½ä½“ç»¼åˆåˆ†æ (ValueCell é£æ ¼)"
        echo "  report <query>          ç”Ÿæˆè¯¦ç»†åˆ†ææŠ¥å‘Š"
        echo "  help                   æ˜¾ç¤ºå¸®åŠ©"
        echo ""
        echo "ç¤ºä¾‹:"
        echo "  finance query stock è‹¹æœ"
        echo "  finance analyze ç‰¹æ–¯æ‹‰"
        echo "  finance multi è‹¹æœå…¬å¸"
        echo "  finance report è‹±ä¼Ÿè¾¾"
        ;;
    *)
        echo "Usage: finance <command>"
        echo "è¿è¡Œ 'finance help' æŸ¥çœ‹å¸®åŠ©"
        ;;
esac
